machine:
  services:
    - redis
    - docker
  post:
    - /usr/bin/redis-server --port 6379:
          background: true
  environment:
    SRC_LOCATION:     "/home/ubuntu/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"
    COVERAGE_PROFILE: "/home/ubuntu/coverage.out"
    GO_LDFLAGS:       '-extldflags "-static" -X main.VERSION=$CIRCLE_TAG -X main.COMMIT_SHA1=$CIRCLE_SHA1 -X main.BUILD_DATE=$(date +%F-%T)'
    MY_GO_VERSION:    "1.8.3"
    GOROOT:           "/usr/local/go"
    GOPATH:           "/home/ubuntu/.go_workspace"
    CDPATH:           ".:$GOPATH/src/github.com:$GOPATH/src/golang.org:$GOPATH/src"
    PATH:             "$GOROOT/bin:$GOPATH/bin:$PATH"

dependencies:
  pre:
    - rm -rf /home/ubuntu/.go_workspace
    - rm -rf /home/ubuntu/.go_project
    - sudo service redis-server stop
    - >
      cd ~ && if [ ! -d "redis-3.2.10" ]; then
        wget http://download.redis.io/releases/redis-3.2.10.tar.gz
        tar xzf redis-3.2.10.tar.gz
        cd redis-3.2.10 && make;
      fi
    - cd ~/redis-3.2.10 && sudo make install
    - sudo sed -i 's/bin/local\/bin/g' /etc/init/redis-server.conf
    - sudo service redis-server start
  cache_directories:
    - ~/redis-3.2.10
  override:
    - sudo apt-get update
    - mkdir -p "/home/ubuntu/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME"
    - ln -s $HOME/$CIRCLE_PROJECT_REPONAME $SRC_LOCATION

test:
  pre:
    - wget https://storage.googleapis.com/golang/go$MY_GO_VERSION.linux-amd64.tar.gz &&  sudo rm -rf /usr/local/go/ &&  sudo tar -C /usr/local -xzf go$MY_GO_VERSION.linux-amd64.tar.gz
    - go version
    - go get github.com/mattn/goveralls
    - go get golang.org/x/tools/cmd/cover
  override:
    - cd $SRC_LOCATION && go test -v -cover -race -coverprofile=$COVERAGE_PROFILE ./exporter/...
  post:
    - if [ -n "$COVERALLS_TOKEN" ]; then /home/ubuntu/.go_workspace/bin/goveralls -coverprofile=$COVERAGE_PROFILE -service=circle-ci -repotoken=$COVERALLS_TOKEN ;  fi
    - cd $SRC_LOCATION && make

deployment:
  publish:
    tag: /v.*/
    commands:
      - go get github.com/mitchellh/gox
      - go get github.com/tcnksm/ghr
      - cd $SRC_LOCATION && make build
      - CGO_ENABLED=0 promu crossbuild tarballs
      - promu checksum .tarballs
      - promu release .tarballs
