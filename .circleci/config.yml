# https://circleci.com/docs/2.0/
version: 2
jobs:

  tests:
    docker:
      - image: golang:1.11
      - image: redis:5
        command: --port 6379
      - image: redis:5
        command: --port 6380
      - image: grokzen/redis-cluster

    working_directory: /go/src/github.com/oliver006/redis_exporter
    steps:
      - checkout
      - run:
          shell: /bin/bash
          name: go fmt
          command: |
            ! gofmt -l $(find . -path ./vendor -prune -o  -type f -name '*.go' -print) 2>&1 | read

      - run: echo " ! gofmt -d main.go       2>&1 | read " | bash
      - run: echo " ! gofmt -d exporter/*.go 2>&1 | read " | bash
      - run: go get github.com/mattn/goveralls
      - run: go get golang.org/x/tools/cmd/cover
      - run: go vet ./exporter/...
      - run: TEST_REDIS_CLUSTER_MASTER_URI=localhost:7000 TEST_REDIS_CLUSTER_SLAVE_URI=localhost:7005 go test -v -covermode=atomic -cover -race -coverprofile=coverage.txt ./exporter/...
      - run: /go/bin/goveralls -coverprofile=coverage.txt -service=circle-ci -repotoken=7rWMRpzVs2gcKnhfdJNbGyE6ycJ6M4fNs
      - run: bash <(curl -s https://codecov.io/bash)


  build:
    docker:
      - image: golang:1.11

    working_directory: /go/src/github.com/oliver006/redis_exporter

    steps:
      - checkout

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Install utilities
          command: |
            apt-get update
            apt-get install -y zip

      - run:
          name: Install Docker client
          command: |
            set -x
            VER="18.03.1-ce"
            curl -L -o /tmp/docker-$VER.tgz https://download.docker.com/linux/static/stable/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin

      - run: ./build.sh


workflows:
  version: 2
  test-build-and-release:
    jobs:
      - tests:
          filters:
            tags:
              only: /.*/
      - build:
          requires:
            - tests
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
